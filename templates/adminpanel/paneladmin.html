{% extends 'adminpanel/paneladmin_base.html' %}
{% block contenido %}

<!-- Agregar producto -->
{% if bloque == 'agregar' %}
<h5 class="mb-4">Nuevo producto</h5>
{% if form.errors or formset.errors %}
  <div class="alert alert-danger">Corrige los errores mostrados abajo.</div>
{% endif %}
<form method="POST" enctype="multipart/form-data">
  {% csrf_token %}
  {{ form.as_p }}
  {{ formset.management_form }}
  {% for f in formset %}{{ f.as_p }}{% endfor %}
  <div class="d-flex justify-content-between mt-3">
    <button type="submit" class="btn btn-primary">Guardar</button>
    <a href="{% url 'panel_admin' %}" class="btn btn-secondary">Cancelar</a>
  </div>
</form>
{% endif %}

<!-- Editar producto -->
{% if bloque == 'editar' %}
<h5 class="mb-4">Editando: {{ producto.nombre }}</h5>
<form method="POST" enctype="multipart/form-data">
  {% csrf_token %}
  {{ form.as_p }}
  {{ formset.management_form }}
  {% for f in formset %}
    <div class="mb-3 border-bottom pb-2">{{ f.as_p }}</div>
  {% endfor %}
  <div class="d-flex justify-content-between mt-3">
    <button type="submit" class="btn btn-warning">Actualizar</button>
    <a href="{% url 'panel_admin' %}" class="btn btn-secondary">Cancelar</a>
  </div>
</form>
{% endif %}

<!-- Confirmar eliminaci√≥n -->
{% if bloque == 'eliminar' %}
<div class="alert alert-warning p-4 mx-auto col-12 col-lg-6">
  <h5 class="mb-3">¬øEliminar "{{ producto.nombre }}"?</h5>
  <form method="POST" class="d-flex gap-2">
    {% csrf_token %}
    <button type="submit" class="btn btn-danger">S√≠, eliminar</button>
    <a href="{% url 'panel_admin' %}" class="btn btn-secondary">Cancelar</a>
  </form>
</div>
{% endif %}

  <!-- Lista de productos -->
  {% if not bloque or bloque == 'agregar' or bloque == 'editar' or bloque == 'eliminar' %}
  {% if productos %}
  <div class="table-responsive bg-white p-3 shadow-sm rounded">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th>Imagen</th>
          <th>Nombre</th>
          <th>Precio</th>
          <th>Stock Total</th>
          <th>Tallas y Stock</th>
          <th>Categor√≠a</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for producto in productos %}
        <tr>
          <td>
            <img src="{{ producto.imagen.url }}" width="60" height="60" class="rounded border" style="object-fit: cover;">
          </td>
          <td>{{ producto.nombre }}</td>
          <td>
            <span class="fw-bold text-success">${{ producto.precio|floatformat:0 }}</span>
          </td>
          <td>
            {% with producto.variantes.all as variantes %}
              <span class="badge bg-primary fs-6">{{ variantes|length }}</span>
            {% endwith %}
          </td>
          <td>
            {% for v in producto.variantes.all %}
              <span class="badge bg-secondary mb-1">{{ v.talla }}: {{ v.stock }}</span>
            {% endfor %}
          </td>
          <td>{{ producto.categoria.nombre }}</td>
          <td>
            <a href="{% url 'panel_admin' %}?accion=editar&id={{ producto.id }}" class="btn btn-warning btn-sm">
              <i class="bi bi-pencil"></i> Editar
            </a>
            <a href="{% url 'panel_admin' %}?accion=eliminar&id={{ producto.id }}" class="btn btn-danger btn-sm">
              <i class="bi bi-trash"></i> Eliminar
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
  {% endif %}

<!-- Ventas -->
{% if bloque == 'ventas' %}
<h4 class="mb-4">Ventas registradas</h4>
{% if ventas %}
<div class="accordion" id="ventasAccordion">
  {% for v in ventas %}
  <div class="accordion-item mb-3">
    <h2 class="accordion-header" id="heading{{ forloop.counter }}">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}">
        Venta #{{ v.id }} ‚Äî {{ v.fecha|date:"d/m/Y H:i" }} ‚Äî {{ v.nombre }} {{ v.apellido }} ‚Äî ${{ v.total|floatformat:0 }}
      </button>
    </h2>
    <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#ventasAccordion">
      <div class="accordion-body">
        <p><strong>M√©todo de entrega:</strong> {{ v.get_metodo_entrega_display }}</p>
        {% if v.metodo_entrega == 'envio' %}
          <p><strong>Empresa de env√≠o:</strong> {{ v.empresa_envio }}</p>
          <p><strong>Direcci√≥n:</strong> {{ v.direccion }}, {{ v.ciudad }}, {{ v.region }}</p>
        {% elif v.metodo_entrega == 'retiro' %}
          <p><strong>RUT:</strong> {{ v.rut }}</p>
        {% endif %}
        <p><strong>Email:</strong> {{ v.email }}</p>
        <p><strong>Tel√©fono:</strong> {{ v.telefono }}</p>
        <p><strong>Estado de pago:</strong> {% if v.pagado %}‚úÖ Pagado{% else %}‚ùå No pagado{% endif %}</p>
        <hr>
        <h6>üßæ Detalles del pedido:</h6>
        <ul>
          {% for item in v.items.all %}
            <li>{{ item.producto_nombre }} ({{ item.talla }}) √ó {{ item.cantidad }} ‚Äî ${{ item.subtotal|floatformat:0 }}</li>
          {% endfor %}
        </ul>
        <p><strong>Total pagado:</strong> ${{ v.total|floatformat:0 }}</p>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<p class="text-muted">A√∫n no hay ventas registradas.</p>
{% endif %}
{% endif %}

<!-- Categor√≠as -->
{% if bloque == 'categoria' %}
<h5 class="mb-4 mt-4">Nueva categor√≠a o subcategor√≠a</h5>
<form method="POST" class="mb-3">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" class="btn btn-primary">Guardar</button>
</form>

<hr>
<h6 class="mb-3">Categor√≠as actuales</h6>
<div class="list-group">
    {% for c in categorias %}
    <div class="list-group-item py-3">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <strong class="fs-5">{{ c.nombre }}</strong>
                {% if c.subcategorias_ordenadas %}
                <div class="mt-2">
                    {% for sub in c.subcategorias_ordenadas %}
                        <span class="badge bg-light text-dark border me-1 mb-1 p-2">
                            {{ sub.nombre }}
                            <a href="{% url 'panel_admin' %}?accion=editarcat&id={{ sub.id }}" class="text-warning ms-1">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <a href="{% url 'panel_admin' %}?accion=eliminarcat&id={{ sub.id }}" class="text-danger ms-1">
                                <i class="bi bi-trash"></i>
                            </a>
                            <!-- Flechas para mover subcategor√≠as (futuro)
                            <a href="{% url 'panel_admin' %}?accion=mover&mover_id={{ sub.id }}&direccion=up" class="text-secondary ms-1"><i class="bi bi-arrow-up"></i></a>
                            <a href="{% url 'panel_admin' %}?accion=mover&mover_id={{ sub.id }}&direccion=down" class="text-secondary ms-1"><i class="bi bi-arrow-down"></i></a>
                            -->
                        </span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            <div>
                <a href="{% url 'panel_admin' %}?accion=editarcat&id={{ c.id }}" class="btn btn-sm btn-warning me-1">
                    <i class="bi bi-pencil"></i>
                </a>
                <a href="{% url 'panel_admin' %}?accion=eliminarcat&id={{ c.id }}" class="btn btn-sm btn-danger">
                    <i class="bi bi-trash"></i>
                </a>
                <!-- Flechas para mover categor√≠as (futuro)
                <a href="{% url 'panel_admin' %}?accion=mover&mover_id={{ c.id }}&direccion=up" class="btn btn-sm btn-secondary"><i class="bi bi-arrow-up"></i></a>
                <a href="{% url 'panel_admin' %}?accion=mover&mover_id={{ c.id }}&direccion=down" class="btn btn-sm btn-secondary"><i class="bi bi-arrow-down"></i></a>
                -->
            </div>
        </div>
    </div>
    {% empty %}
    <p class="text-muted">No hay categor√≠as a√∫n.</p>
    {% endfor %}
</div>
{% endif %}





<!-- Editar Categor√≠as -->
{% if bloque == 'editarcat' %}
<h5 class="mb-4">Editando categor√≠a: {{ categoria.nombre }}</h5>
<form method="POST" class="d-flex flex-column gap-2">
  {% csrf_token %}
  {{ form.as_p }}
  <div>
    <button type="submit" class="btn btn-primary">Actualizar</button>
    <a href="{% url 'panel_admin' %}?accion=categoria" class="btn btn-secondary">Cancelar</a>
  </div>
</form>
{% endif %}

<!-- Eliminar Categor√≠as -->
{% if bloque == 'eliminarcat' %}
<div class="alert alert-warning p-4 mx-auto col-12 col-lg-6">
  <h5>¬øEliminar la categor√≠a "{{ categoria.nombre }}"?</h5>
  <form method="POST" class="d-flex gap-2">
    {% csrf_token %}
    <button type="submit" class="btn btn-danger">S√≠, eliminar</button>
    <a href="{% url 'panel_admin' %}?accion=categoria" class="btn btn-secondary">Cancelar</a>
  </form>
</div>
{% endif %}

{% endblock %}
